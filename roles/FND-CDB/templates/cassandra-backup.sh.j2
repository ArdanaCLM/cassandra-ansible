#!/bin/sh
#
# (c) Copyright 2018 SUSE LLC
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
set -e
set -x
# Setup variables
DATA_DIR={{ cassandra_data_dir }}
NODETOOL=/usr/bin/nodetool
SNAPSHOT_NAME=cassandra-snp-$(date +%F-%H%M)
HOST_NAME=$(/bin/hostname)_

# Take a snapshot of cassandra database
$NODETOOL snapshot -t $SNAPSHOT_NAME monasca

# Collect a list of directorys that make up the snapshot
SNAPSHOT_DIR_LIST=$(find $DATA_DIR -type d -name $SNAPSHOT_NAME)
# upload each of the directories in snapshot to swift.
for d in $SNAPSHOT_DIR_LIST
  do
    set +x
    swift --os-auth-url={{ FRE_AGN.consumes_KEY_API.vips.private[0].url }}/v3\
          --os-project-name={{ FRE_AGN.consumes_KEY_API.vars.keystone_backup_tenant }}\
          --os-project-domain-name=Default\
          --os-user-domain-name=Default\
          --auth-version=3\
          --os-endpoint-type=internalURL\
          --os-cacert={{ trusted_ca_bundle }}\
          --os-identity-api-version=3\
          upload $HOST_NAME$SNAPSHOT_NAME $d
    set -x
  done

$NODETOOL clearsnapshot monasca
